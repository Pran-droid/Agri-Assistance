{% extends 'base.html' %}
{% block title %}Market Prices | AgriAssist{% endblock %}
{% block content %}
<div id="loading" style="text-align: center; padding: 50px;">
    <h2>Loading Market Data...</h2>
    <div class="spinner"></div>
</div>

<section class="content-card" id="market-content" style="display: none; max-width: 1400px; width: 95%;">
    <header class="card-header">
        <div class="header-text">
            <h1>Current Daily Mandi Prices</h1>
            <p class="subtitle" id="description">Loading...</p>
            <p style="margin-top: 10px;"><strong>Last Updated:</strong> <span id="updatedOn">Loading...</span></p>
        </div>
    </header>

    <div style="margin: 20px 0; display: flex; gap: 15px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by State:</label>
            <select id="select_state" onchange="onStateChange()" 
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <option value="">All States</option>
            </select>
        </div>
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by District:</label>
            <select id="select_district" onchange="onDistrictChange()" 
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <option value="">All Districts</option>
            </select>
        </div>
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Commodity:</label>
            <select id="select_commodity" onchange="onCommodityChange()" 
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <option value="">All Commodities</option>
            </select>
        </div>
    </div>

    <div style="overflow-x: auto; margin-top: 20px;">
        <table class="table" style="width: 100%; border-collapse: collapse;">
            <thead style="background-color: var(--accent); color: white;">
                <tr>
                    <th style="padding: 12px; text-align: left;">Sr. No.</th>
                    <th style="padding: 12px; text-align: left;">State</th>
                    <th style="padding: 12px; text-align: left;">District</th>
                    <th style="padding: 12px; text-align: left;">Market</th>
                    <th style="padding: 12px; text-align: left;">Commodity</th>
                    <th style="padding: 12px; text-align: left;">Variety</th>
                    <th style="padding: 12px; text-align: left;">Min Price (₹)</th>
                    <th style="padding: 12px; text-align: left;">Max Price (₹)</th>
                    <th style="padding: 12px; text-align: left;">Modal Price (₹)</th>
                </tr>
            </thead>
            <tbody id="market_price_body">
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>
</section>

<style>
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.table tbody tr {
    border-bottom: 1px solid #ddd;
}

.table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.table tbody td {
    padding: 12px;
}
</style>

<script>
// Page onload functionality
let loader = document.getElementById('loading');
let marketContent = document.getElementById('market-content');

function myloader() { 
    loader.style.display = 'none';
    marketContent.style.display = 'block';
}

// Global data storage
let allRecords = [];
let filteredRecords = [];
let currentFilters = {
    state: '',
    district: '',
    commodity: ''
};

// DOM elements
const stateSelect = document.getElementById('select_state');
const districtSelect = document.getElementById('select_district');
const commoditySelect = document.getElementById('select_commodity');

// API Configuration
const url = 'https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=579b464db66ec23bdd0000017704f08e67e4414747189afb9ef2d662&format=json&offset=0&limit=4000';

// Fetch data from API
fetch(url)
    .then(response => {
        return response.json();
    })
    .then(data => {
        getData(data);
    })
    .catch(err => {
        console.error('Error fetching market data:', err);
        loader.innerHTML = '<h2 style="color: red;">Failed to load market data. Please try again later.</h2>';
    });

// Process the fetched data
function getData(result) {
    console.log('Data received:', result);
    
    // Extract and display data
    if (result.updated_date) {
        getDate(result.updated_date);
    }
    
    if (result.desc) {
        getDesc(result.desc);
    }
    
    if (result.records && result.records.length > 0) {
        allRecords = result.records;
        filteredRecords = result.records;
        
        // Initialize all dropdowns
        populateStateDropdown();
        populateDistrictDropdown();
        populateCommodityDropdown();
        
        // Display all records initially
        getRecords(filteredRecords);
    } else {
        document.getElementById('market_price_body').innerHTML = 
            '<tr><td colspan="9" style="text-align: center; padding: 20px;">No data available</td></tr>';
    }
    
    myloader();
}

// Display the updated date
function getDate(date) {
    var update = new Date(date);
    document.getElementById('updatedOn').innerHTML = update.toDateString();
}

// Display description
function getDesc(desc) {
    document.getElementById('description').innerHTML = desc;
}

// Populate state dropdown
function populateStateDropdown() {
    const uniqueStates = [...new Set(allRecords.map(r => r.state))].filter(s => s).sort();
    
    stateSelect.innerHTML = '<option value="">All States</option>';
    uniqueStates.forEach(stateName => {
        const option = document.createElement('option');
        option.value = stateName;
        option.textContent = stateName;
        stateSelect.appendChild(option);
    });
}

// Populate district dropdown based on selected state
function populateDistrictDropdown() {
    const recordsToFilter = currentFilters.state 
        ? allRecords.filter(r => r.state === currentFilters.state)
        : allRecords;
    
    const uniqueDistricts = [...new Set(recordsToFilter.map(r => r.district))].filter(d => d).sort();
    
    districtSelect.innerHTML = '<option value="">All Districts</option>';
    uniqueDistricts.forEach(districtName => {
        const option = document.createElement('option');
        option.value = districtName;
        option.textContent = districtName;
        districtSelect.appendChild(option);
    });
    
    // Restore selection if it still exists
    if (currentFilters.district && uniqueDistricts.includes(currentFilters.district)) {
        districtSelect.value = currentFilters.district;
    } else {
        currentFilters.district = '';
    }
}

// Populate commodity dropdown based on selected state and district
function populateCommodityDropdown() {
    let recordsToFilter = allRecords;
    
    if (currentFilters.state) {
        recordsToFilter = recordsToFilter.filter(r => r.state === currentFilters.state);
    }
    if (currentFilters.district) {
        recordsToFilter = recordsToFilter.filter(r => r.district === currentFilters.district);
    }
    
    const uniqueCommodities = [...new Set(recordsToFilter.map(r => r.commodity))].filter(c => c).sort();
    
    commoditySelect.innerHTML = '<option value="">All Commodities</option>';
    uniqueCommodities.forEach(commodityName => {
        const option = document.createElement('option');
        option.value = commodityName;
        option.textContent = commodityName;
        commoditySelect.appendChild(option);
    });
    
    // Restore selection if it still exists
    if (currentFilters.commodity && uniqueCommodities.includes(currentFilters.commodity)) {
        commoditySelect.value = currentFilters.commodity;
    } else {
        currentFilters.commodity = '';
    }
}

// Handle state change
function onStateChange() {
    currentFilters.state = stateSelect.value;
    currentFilters.district = '';
    currentFilters.commodity = '';
    
    // Update dependent dropdowns
    populateDistrictDropdown();
    populateCommodityDropdown();
    
    // Apply filters and update table
    applyFilters();
}

// Handle district change
function onDistrictChange() {
    currentFilters.district = districtSelect.value;
    currentFilters.commodity = '';
    
    // Update dependent dropdown
    populateCommodityDropdown();
    
    // Apply filters and update table
    applyFilters();
}

// Handle commodity change
function onCommodityChange() {
    currentFilters.commodity = commoditySelect.value;
    
    // Apply filters and update table
    applyFilters();
}

// Apply all active filters
function applyFilters() {
    filteredRecords = allRecords;
    
    if (currentFilters.state) {
        filteredRecords = filteredRecords.filter(r => r.state === currentFilters.state);
    }
    if (currentFilters.district) {
        filteredRecords = filteredRecords.filter(r => r.district === currentFilters.district);
    }
    if (currentFilters.commodity) {
        filteredRecords = filteredRecords.filter(r => r.commodity === currentFilters.commodity);
    }
    
    getRecords(filteredRecords);
}

// Populate table with records
function getRecords(record) {
    const tbody = document.getElementById('market_price_body');
    tbody.innerHTML = ''; // Clear existing data
    
    if (record.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No records found for the selected filters</td></tr>';
        return;
    }
    
    for(let i = 0; i < record.length; i++) {
        const sr = i + 1;
        const state = record[i].state || 'N/A';
        const districts = record[i].district || 'N/A';
        const market = record[i].market || 'N/A';
        const commodity = record[i].commodity || 'N/A';
        const variety = record[i].variety || 'N/A';
        const min_price = record[i].min_price || 'N/A';
        const max_price = record[i].max_price || 'N/A';
        const modal_price = record[i].modal_price || 'N/A';
        
        const tTr = document.createElement('tr');
        tTr.innerHTML = '<th scope="row">' + sr + '</th>' + '\n' +
            '<td>' + state + '</td>' + '\n' +
            '<td>' + districts + '</td>' + '\n' +
            '<td>' + market + '</td>' + '\n' +
            '<td>' + commodity + '</td>' + '\n' +
            '<td>' + variety + '</td>' + '\n' +
            '<td>' + min_price + '</td>' + '\n' +
            '<td>' + max_price + '</td>' + '\n' +
            '<td>' + modal_price + '</td>' + '\n';
        tbody.appendChild(tTr);
    }
}
</script>
{% endblock %}
