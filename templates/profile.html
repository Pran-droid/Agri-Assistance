{% extends 'base.html' %}
{% block title %}My Profile | AgriAssist{% endblock %}
{% block content %}
<section class="content-card">
    <header class="card-header">
        <div class="header-text">
            <h1>{{ user.name }}</h1>
            <p class="subtitle">Your farmer profile and preferences.</p>
        </div>
        <a href="{{ url_for('chat') }}" class="primary-btn">Go to Chat</a>
    </header>
    <div class="info-grid">
        <div>
            <span class="label">Email</span>
            <p>{{ user.email }}</p>
        </div>
    </div>

    {% if message %}
    <div class="alert {% if message_class %}{{ message_class }}{% endif %}">{{ message }}</div>
    {% endif %}

    <form method="post" class="profile-form">
        <div class="form-grid">
            <label>
                Location
                <input type="text" name="location" value="{{ user.location or '' }}" placeholder="Enter your location">
            </label>
            <label>
                Preferred Language
                <select name="preferred_language">
                    {% for code, label in language_choices %}
                    <option value="{{ code }}" {% if user.preferred_language == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                My Crops
                <select name="crops" id="cropsSelect">
                    <option value="">Loading crops...</option>
                </select>
                <span class="helper-text">Select your primary crop.</span>
            </label>
        </div>
        <div class="form-actions">
            <button type="submit" class="primary-btn">Save Changes</button>
        </div>
    </form>
</section>

<style>
#cropsSelect {
    padding: 8px;
}
</style>

<script>
// Load available crops from API
document.addEventListener('DOMContentLoaded', async () => {
    const cropsSelect = document.getElementById('cropsSelect');
    const userCrops = {{ user.crops | tojson }};
    const userCrop = userCrops && userCrops.length > 0 ? userCrops[0] : '';
    
    try {
        const response = await fetch('/api/market/filters');
        const data = await response.json();
        
        // Clear loading option
        cropsSelect.innerHTML = '<option value="">Select a crop</option>';
        
        // Populate with commodities from market data
        data.commodities.forEach(crop => {
            const option = document.createElement('option');
            option.value = crop;
            option.textContent = crop;
            
            // Pre-select user's existing crop
            if (userCrop && userCrop === crop) {
                option.selected = true;
            }
            
            cropsSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading crops:', error);
        cropsSelect.innerHTML = '<option value="">Error loading crops</option>';
    }
});
</script>
{% endblock %}
